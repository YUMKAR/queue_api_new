<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ğŸ† ìœ ë ¹ ê²Œì„ ë­í‚¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Creepster&family=Noto+Sans+KR:wght@400;700&display=swap");

      /* í• ë¡œìœˆ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ */
      :root {
        --bg: #111111; /* Ultra Dark background */
        --panel: #1a1a1a; /* Dark panel background */
        --item-bg: #333333; /* Card Background */
        --orange-accent: #ff7800; /* Halloween Orange */
        --purple-accent: #8a2be2; /* Spooky Purple */
        --neon-green: #ccff00; /* Neon Green Highlight */
        --text: #f3f4f6;
        --rank-item-bg: #444444; /* Rank list item background */
        --rank-item-hover: #555555;
      }

      body {
        font-family: "Noto Sans KR", sans-serif;
        background-color: var(--bg);
        color: var(--text);
        padding: 20px;
        /* ë°°ê²½ íŒ¨í„´ ì¶”ê°€ */
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="%23333333" d="M30 0l20 20l-20 20l-20-20zM70 0l20 20l-20 20l-20-20zM30 60l20 20l-20 20l-20-20zM70 60l20 20l-20 20l-20-20z"/><path fill="%2222222" d="M10 30l20 20l-20 20l-20-20zM50 30l20 20l-20 20l-20-20zM10 90l20 20l-20 20l-20-20zM50 90l20 20l-20 20l-20-20z"/></svg>');
        background-size: 40px 40px;
      }

      .spooky-font {
        font-family: "Creepster", cursive;
      }

      #ranking-grid .game-card {
        background-color: var(--item-bg);
        border: 2px solid var(--purple-accent);
        box-shadow: 0 0 15px rgba(138, 43, 226, 0.3);
        transition: transform 0.3s ease;
      }

      #ranking-grid .game-card:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 0 25px rgba(255, 120, 0, 0.5);
      }

      .rank-item {
        background-color: var(--rank-item-bg);
        border-left: 5px solid var(--orange-accent);
        transition: all 0.2s ease;
      }

      .rank-item:hover {
        background-color: var(--rank-item-hover);
        border-left-color: var(--neon-green);
      }

      .score-text {
        color: var(--neon-green);
      }
    </style>
  </head>

  <body class="p-6 md:p-10">
    <header class="text-center mb-10">
      <h1
        class="text-5xl md:text-6xl font-extrabold text-orange-accent spooky-font mb-2 flex items-center justify-center gap-3"
      >
        <i class="fas fa-trophy text-purple-accent"></i> ê²Œì„ ë­í‚¹
        <i class="fas fa-ghost text-purple-accent"></i>
      </h1>
      <p class="text-xl text-text mt-4">
        ê°€ì¥ ìœ¼ìŠ¤ìŠ¤í•œ ì ìˆ˜ë¥¼ íšë“í•œ ìœ ë ¹ë“¤ì„ í™•ì¸í•˜ì„¸ìš”!
      </p>
    </header>

    <main class="max-w-7xl mx-auto">
      <section
        style="background: var(--panel); border: 2px solid var(--orange-accent)"
        class="p-6 md:p-8 rounded-3xl shadow-2xl"
      >
        <div id="ranking-list-container">
          <div
            id="ranking-grid"
            class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6"
          ></div>
        </div>
      </section>
    </main>

    <script>
  let GAMES = []; // APIì—ì„œ ë°›ì€ ê²Œì„ ID ë¦¬ìŠ¤íŠ¸ ("1", "2", ...)
  const rankingGrid = document.getElementById("ranking-grid");

  // ğŸ‘» ê²Œì„ IDì™€ ì‚¬ìš©ì ì¹œí™”ì ì¸ ê²Œì„ ì´ë¦„ ë§¤í•‘
  const GAMES_MAP = {
    "1": "EggTime",
    "2": "Pink O Park",
    "3": "Defend & Destroy",
    "4": "ëê¹Œì§€ ë§‰ì•„ë¼!",
    "5": "ë©”í…Œì˜¤ í”¼í•˜ê¸°!",
  };

  // ì„œë²„ì—ì„œ ê²Œì„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
  async function fetchGames() {
    try {
      const apiBase = window.location.origin;
      const response = await fetch(`${apiBase}/api/v1/games`);
      const data = await response.json();

      GAMES = data.games;

      createSections();
      connectWebSocket();
    } catch (error) {
      console.error("ê²Œì„ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", error);
      GAMES = ["1", "2", "3", "4", "5"];
      createSections();
    }
  }

  // WebSocket URL ì„¤ì •
  const host = window.location.host;
  const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
  const websocketUrl = `${wsProtocol}//${host}/api/v1/queue/ws`;

  // ê° ê²Œì„ë³„ ì„¹ì…˜ì„ ë™ì ìœ¼ë¡œ ìƒì„±
  function createSections() {
    rankingGrid.innerHTML = "";
    GAMES.forEach((gameId) => {
      const card = document.createElement("section");
      card.className = "game-card p-5 rounded-2xl shadow-xl flex flex-col";

      const gameName = GAMES_MAP[gameId] || `ê²Œì„ ID: ${gameId}`;

      const title = document.createElement("h2");
      title.className =
        "text-2xl font-bold spooky-font text-purple-accent mb-4 truncate text-center";
      title.textContent = gameName.toUpperCase();

      const ol = document.createElement("ol");
      ol.id = `ranking-list-${gameId}`;
      ol.className =
        "space-y-3 list-decimal list-inside flex-1 overflow-hidden";

      const empty = document.createElement("li");
      empty.className = "text-lg text-gray-400 py-2 text-center";
      empty.textContent = "ë­í‚¹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
      ol.appendChild(empty);

      card.appendChild(title);
      card.appendChild(ol);
      rankingGrid.appendChild(card);
    });
  }

  function maskName(name) {
    if (!name) return "";
    if (name.length <= 1) return name;
    return name[0] + "*".repeat(name.length - 1);
  }

  // âœ… ìˆ˜ì •ëœ ë¶€ë¶„: 2ë²ˆ ê²Œì„ë§Œ ì •ë ¬/í‘œì‹œ ë°©ì‹ ë³€ê²½
  function updateAllRankings(rankingData) {
    GAMES.forEach((gameId) => {
      const listEl = document.getElementById(`ranking-list-${gameId}`);
      if (!listEl) return;
      listEl.innerHTML = "";

      const gameRanking = rankingData[gameId] || [];

      // âš™ï¸ ì •ë ¬ ê¸°ì¤€ ë¶„ê¸°
      if (gameId === "2") {
        // 2ë²ˆ: ì‹œê°„ì´ ì ì„ìˆ˜ë¡ ë†’ì€ ìˆœìœ„
        gameRanking.sort((a, b) => a.score - b.score);
      } else {
        // ë‚˜ë¨¸ì§€: ì ìˆ˜ê°€ ë†’ì„ìˆ˜ë¡ ë†’ì€ ìˆœìœ„
        gameRanking.sort((a, b) => b.score - a.score);
      }

      if (gameRanking.length === 0) {
        const empty = document.createElement("li");
        empty.className = "text-lg text-gray-400 py-2 text-center";
        empty.innerHTML =
          '<i class="fas fa-spider"></i> ë­í‚¹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.';
        listEl.appendChild(empty);
      } else {
        gameRanking.forEach((item, index) => {
          const li = document.createElement("li");
          li.className =
            "rank-item flex justify-between items-center text-base md:text-lg p-3 rounded-xl transition duration-150";

          let rankIcon = "";
          let rankNameClass = "text-text";
          let scoreClass = "score-text";

          if (index === 0) {
            rankIcon = '<i class="fas fa-crown text-neon-green mr-2"></i>';
            rankNameClass = "font-extrabold text-neon-green text-xl";
          } else if (index === 1) {
            rankIcon = '<i class="fas fa-medal text-gray-400 mr-2"></i>';
            rankNameClass = "font-bold text-gray-300";
          } else if (index === 2) {
            rankIcon =
              '<i class="fas fa-medal text-orange-accent mr-2"></i>';
            rankNameClass = "font-bold text-orange-accent";
          }

          const nameSpan = document.createElement("span");
          nameSpan.className = `${rankNameClass} truncate`;
          nameSpan.innerHTML = `${rankIcon}${item.name}`;

          const scoreSpan = document.createElement("span");
          scoreSpan.className =
            `${scoreClass} font-extrabold ml-4 whitespace-nowrap`;

          // âš™ï¸ ì ìˆ˜ í¬ë§· ë¶„ê¸°
          if (gameId === "2") {
            // 2ë²ˆ ê²Œì„: ì´ˆ ë‹¨ìœ„ë¥¼ 'ë¶„:ì´ˆ'ë¡œ í‘œì‹œ
            const totalSeconds = Math.floor(parseFloat(item.score));
            const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, "0");
            const seconds = String(totalSeconds % 60).padStart(2, "0");
            scoreSpan.textContent = `${minutes}:${seconds}`;
          } else {
            // ê¸°ë³¸: 'ì 'ìœ¼ë¡œ í‘œì‹œ
            scoreSpan.textContent = `${item.score}ì `;
          }

          li.appendChild(nameSpan);
          li.appendChild(scoreSpan);
          listEl.appendChild(li);
        });
      }
    });
  }

  // WebSocket ì—°ê²°
  function connectWebSocket() {
    const ws = new WebSocket(websocketUrl);
    ws.onmessage = function (ev) {
      try {
        const data = JSON.parse(ev.data);
        if (data.ranking_list) {
          updateAllRankings(data.ranking_list);
        }
      } catch (e) {
        console.error("WebSocket ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:", e);
      }
    };

    ws.onopen = () => {
      console.log("WebSocket connected for rankings");
    };

    ws.onclose = () => {
      console.warn("WebSocket disconnected. Reconnecting...");
      setTimeout(connectWebSocket, 5000);
    };

    ws.onerror = (err) => {
      console.error("WS error for rankings:", err);
      try {
        ws.close();
      } catch (e) {}
    };
  }

  // ì´ˆê¸°í™”
  fetchGames();
</script>

  </body>
</html>
