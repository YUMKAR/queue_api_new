<!DOCTYPE html>
<html lang="ko">
  <head>
    <title>ë­í‚¹ ê´€ë¦¬ í˜ì´ì§€</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* ê³µí†µ ìŠ¤íƒ€ì¼ */
      body {
        font-family: "Inter", sans-serif;
        background-color: #1f2937;
        color: #f3f4f6;
      }
      /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #374151;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #6b7280;
        border-radius: 4px;
      }
    </style>
  </head>
  <body class="p-6 md:p-10">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <header class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-extrabold text-yellow-400 mb-2">
        ğŸ† ê²Œì„ë³„ ë­í‚¹ ê´€ë¦¬
      </h1>
      <p class="text-lg md:text-xl text-gray-300">
        ê° ê²Œì„ì˜ ìµœê³  ì ìˆ˜ ê¸°ë¡ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”.
      </p>
    </header>
    <main
      class="max-w-7xl mx-auto bg-gray-800 p-6 md:p-8 rounded-xl shadow-2xl"
    >
      <section class="mt-8">
        <div class="flex justify-between items-center mb-4">
          <p class="text-gray-400 text-sm">
            â€» ì ìˆ˜ëŠ” ë‚´ë¦¼ì°¨ìˆœ, ìˆœìœ„ëŠ” ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
          </p>
          <button
            onclick="loadAllRankings()"
            class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-150"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 inline-block mr-1"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V4a1 1 0 011-1zm10 8a1 1 0 011-1v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 111.885-.666A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V4a1 1 0 011-1z"
                clip-rule="evenodd"
              />
            </svg>
            ìƒˆë¡œê³ ì¹¨
          </button>
        </div>

        <div
          id="game-rankings-container"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4"
        >
          <div class="text-lg text-gray-400 py-2 col-span-full">
            ê²Œì„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
          </div>
        </div>
      </section>
    </main>

    <script>
      // API BASE URLì„ ë™ì ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
      const API_BASE_URL =
        window.location.protocol + "//" + window.location.host + "/api/v1";

      // ğŸš¨ ì¶”ê°€: APIì—ì„œ ì˜¤ëŠ” string keyì™€ ì‹¤ì œ í‘œì‹œí•  ì´ë¦„ì„ ë§¤í•‘í•˜ëŠ” ê°ì²´
      const GAME_NAMES = {
        "1": "EggTime",
        "2": "Pink O Park",
        "3": "Defend & Destroy",
        "4": "ëê¹Œì§€ ë§‰ì•„ë¼!",
        "5": "í”¼í•´ë³´ë˜ê°€!",
        // APIì—ì„œ ìƒˆë¡œìš´ ê²Œì„ IDê°€ ì¶”ê°€ë˜ë©´ ì—¬ê¸°ì— ëŒ€ì‘í•˜ëŠ” ì´ë¦„ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.
      };

      let GAMES = []; // APIì—ì„œ ë°›ì•„ì˜¨ key ê°’ (ì˜ˆ: "1", "2", "3") ëª©ë¡
      const gameRankingsContainer = document.getElementById(
        "game-rankings-container"
      );

      /**
       * ê²Œì„ ID(string key)ë¥¼ ì‚¬ìš©ì ì¹œí™”ì ì¸ ì´ë¦„ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
       * @param {string} gameId - APIì—ì„œ ë°›ì€ ê²Œì„ ID ("1", "2", "3" ë“±)
       * @returns {string} ì‚¬ìš©ì ì¹œí™”ì ì¸ ê²Œì„ ì´ë¦„
       */
      function getGameDisplayName(gameId) {
        // ë§¤í•‘ëœ ì´ë¦„ì´ ìˆìœ¼ë©´ ê·¸ ì´ë¦„ì„ ë°˜í™˜í•˜ê³ , ì—†ìœ¼ë©´ ID ìì²´ë¥¼ ë°˜í™˜
        return GAME_NAMES[gameId] || `Game ${gameId}`;
      }

      /**
       * ì„œë²„ì—ì„œ ê²Œì„ ëª©ë¡ì„ ë¶ˆëŸ¬ì™€ GAMES ë³€ìˆ˜ë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  ë­í‚¹ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
       */
      async function loadGames() {
        try {
          const response = await fetch(`${API_BASE_URL}/games`);
          if (!response.ok) {
            throw new Error("ê²Œì„ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨");
          }
          const data = await response.json();
          GAMES = data.games || [];
          console.log("ê²Œì„ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:", GAMES);

          // ê²Œì„ ëª©ë¡ ë¡œë“œ í›„ ë­í‚¹ ì„¹ì…˜ UI ìƒì„± ë° ë°ì´í„° ë¡œë“œ ì‹œì‘
          createGameRankingSections();
          loadAllRankings();
        } catch (error) {
          console.error("ê²Œì„ ëª©ë¡ì„ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
          gameRankingsContainer.innerHTML = `<div class="text-lg text-red-400 py-2 col-span-full">
              âš ï¸ ê²Œì„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.
            </div>`;
        }
      }

      /**
       * GAMES ëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ê²Œì„ë³„ ë­í‚¹ ì„¹ì…˜ HTMLì„ ìƒì„±í•©ë‹ˆë‹¤.
       */
      function createGameRankingSections() {
        gameRankingsContainer.innerHTML = "";
        if (GAMES.length === 0) {
          gameRankingsContainer.innerHTML = `<div class="text-lg text-red-400 py-2 col-span-full">
                ê²Œì„ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.
              </div>`;
          return;
        }

        // ğŸš¨ ìˆ˜ì •: getGameDisplayName í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¹ì…˜ ì œëª©ì„ ì„¤ì •
        GAMES.forEach((gameId) => {
          const section = document.createElement("div");
          section.className =
            "bg-gray-700 p-4 rounded-lg shadow-xl flex flex-col h-full";

          const displayName = getGameDisplayName(gameId); // ì‚¬ìš©ì ì¹œí™”ì  ì´ë¦„ ì‚¬ìš©

          section.innerHTML = `
                  <h3 class="text-xl font-bold text-yellow-400 mb-3 border-b border-gray-600 pb-2">
                      ${displayName}
                  </h3>
                  <div class="flex-none grid grid-cols-5 text-xs font-semibold text-gray-400 pb-1 border-b border-gray-600">
                      <span class="col-span-1">#</span>
                      <span class="col-span-2">ì´ë¦„</span>
                      <span class="col-span-1">ì ìˆ˜</span>
                      <span class="col-span-1 text-right">ê´€ë¦¬</span>
                  </div>
                  <div class="flex-grow overflow-y-auto custom-scrollbar max-h-96">
                      <ul id="rankings-list-game-${gameId}" class="space-y-2 pt-2">
                          <li class="text-sm text-gray-400 py-1">ë­í‚¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
                      </ul>
                  </div>
              `;
          gameRankingsContainer.appendChild(section);
        });
      }

      /**
       * ëª¨ë“  ë­í‚¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™€ ê²Œì„ë³„ë¡œ ë¶„ë¥˜í•˜ì—¬ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
       */
      async function loadAllRankings() {
        if (GAMES.length === 0) {
          console.log("ê²Œì„ ëª©ë¡ ë¡œë“œ ëŒ€ê¸° ì¤‘...");
          return;
        }

        try {
          const response = await fetch(`${API_BASE_URL}/rankings/all`);
          if (!response.ok) {
            throw new Error("ì „ì²´ ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨");
          }
          const allRankings = await response.json();

          updateAllRankingsDisplay(allRankings);
        } catch (error) {
          console.error("ì „ì²´ ë­í‚¹ ë¡œë“œ ì˜¤ë¥˜:", error);

          // ê° ê²Œì„ë³„ ë¦¬ìŠ¤íŠ¸ë¥¼ ì˜¤ë¥˜ ë©”ì‹œì§€ë¡œ ì±„ì›€
          GAMES.forEach((gameId) => {
            const listElement = document.getElementById(
              `rankings-list-game-${gameId}`
            );
            if (listElement) {
              listElement.innerHTML = `<li class="text-sm text-red-400 py-1">ë¡œë“œ ì‹¤íŒ¨.</li>`;
            }
          });
        }
      }

      /**
       * ì „ì²´ ë­í‚¹ ëª©ë¡ì„ ë°›ì•„ ê²Œì„ë³„ë¡œ í•„í„°ë§ ë° ì •ë ¬í•˜ì—¬ í™”ë©´ì— ê·¸ë¦½ë‹ˆë‹¤.
       */
      function updateAllRankingsDisplay(allRankings) {
        GAMES.forEach((gameId) => {
          const listElement = document.getElementById(
            `rankings-list-game-${gameId}`
          );
          if (!listElement) return;

          // 1. í•´ë‹¹ ê²Œì„ì˜ ë­í‚¹ë§Œ í•„í„°ë§ (API key ì‚¬ìš©)
          let gameRankings = allRankings.filter((item) => item.game === gameId);

          // 2. ì ìˆ˜(score) ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
          gameRankings.sort((a, b) => b.score - a.score);

          listElement.innerHTML = "";

          if (gameRankings.length === 0) {
            listElement.innerHTML = `<li class="text-sm text-gray-400 py-1">ë“±ë¡ëœ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤.</li>`;
            return;
          }

          // 3. ë­í‚¹ í•­ëª© ìƒì„± ë° í‘œì‹œ
          gameRankings.forEach((item, index) => {
            const li = document.createElement("li");
            li.className =
              "grid grid-cols-5 gap-1 items-center bg-gray-600 hover:bg-gray-500 p-2 rounded-md transition duration-150 text-sm";

            li.innerHTML = `
                      <div class="col-span-1 font-bold text-blue-300">${
                        index + 1
                      }</div>
                      <div class="col-span-2 font-semibold truncate text-white">${
                        item.name
                      }</div>
                      <div class="col-span-1 font-bold text-yellow-300">${
                        item.score
                      }</div>
                  `;

            const buttonDiv = document.createElement("div");
            buttonDiv.className = "col-span-1 flex justify-end";

            const deleteButton = document.createElement("button");
            deleteButton.className =
              "bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded transition duration-150";
            deleteButton.textContent = "ì‚­ì œ";
            deleteButton.onclick = () =>
              deleteRanking(item.name, item.game, item.score);

            buttonDiv.appendChild(deleteButton);
            li.appendChild(buttonDiv);
            listElement.appendChild(li);
          });
        });
      }

      /**
       * íŠ¹ì • ë­í‚¹ í•­ëª©ì„ ì‚­ì œí•©ë‹ˆë‹¤.
       */
      async function deleteRanking(name, game, score) {
        const displayName = getGameDisplayName(game); // ì‚¬ìš©ì ì¹œí™”ì  ì´ë¦„ ì‚¬ìš©

        if (
          !confirm(
            `'${name}'ë‹˜ì˜ '${displayName}' ë­í‚¹(ì ìˆ˜: ${score})ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
          )
        ) {
          return;
        }

        try {
          const response = await fetch(`${API_BASE_URL}/rankings`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, game, score }),
          });
          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.detail || "ë­í‚¹ ì‚­ì œ ì‹¤íŒ¨");
          }
          alert(result.message);
          loadAllRankings(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } catch (error) {
          alert(`ë­í‚¹ ì‚­ì œ ì˜¤ë¥˜: ${error.message}`);
        }
      }

      // ğŸš€ í˜ì´ì§€ ë¡œë“œ ì‹œ ë­í‚¹ ì •ë³´ë¥¼ ì¦‰ì‹œ ë¡œë“œí•©ë‹ˆë‹¤.
      loadGames();
    </script>
  </body>
</html>