<!DOCTYPE html>
<html lang="ko">
  <head>
    <title>🎃 유령 대기열 등록</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Creepster&display=swap");

      body {
        /* 어둡고 스산한 배경 */
        background-color: #1a1a1a;
        color: #f0f0f0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
        /* 배경 패턴 추가 */
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="10" fill="%23333333" opacity="0.1"/><circle cx="50" cy="50" r="20" fill="none" stroke="%23333333" stroke-width="1" opacity="0.05"/></svg>');
        background-size: 20px 20px;
      }

      /* Creepster 폰트를 제목에 사용 */
      .spooky-font {
        font-family: "Creepster", cursive;
      }

      /* 주황색 테마 색상 정의 */
      .bg-halloween-orange {
        background-color: #ff7800;
      }
      .text-halloween-orange {
        color: #ff7800;
      }
      .hover\:bg-halloween-dark-orange:hover {
        background-color: #e66b00;
      }
      .focus\:ring-halloween-orange:focus {
        --tw-ring-color: #ff7800;
      }

      /* 네온 그린 성공 색상 정의 */
      .bg-neon-green {
        background-color: #ccff00;
      }
      .text-neon-green {
        color: #ccff00;
      }

      /* 할로윈 박스 스타일 */
      .halloween-box {
        background-color: #333333; /* Darker grey for card */
        border: 3px solid #8a2be2; /* Purple border */
        box-shadow: 0 0 30px rgba(138, 43, 226, 0.5); /* Purple glow */
      }
    </style>
  </head>
  <body class="p-6 md:p-10">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
              spooky: ["Creepster", "cursive"],
            },
            colors: {
              "halloween-orange": "#ff7800",
              "halloween-dark-orange": "#e66b00",
              "neon-green": "#ccff00",
              "spooky-purple": "#8a2be2",
              "spooky-red": "#6a0505",
            },
          },
        },
      };
    </script>

    <div
      class="halloween-box p-8 md:p-10 rounded-3xl shadow-2xl max-w-sm w-full text-center transform transition duration-500 hover:scale-[1.02]"
    >
      <h1
        class="text-4xl md:text-5xl font-extrabold text-halloween-orange mb-6 spooky-font flex items-center justify-center gap-3"
      >
        <i class="fas fa-ghost text-spooky-purple"></i> 유령 등록부
        <i class="fas fa-pumpkin text-halloween-orange"></i>
      </h1>

      <form id="register-form" class="flex flex-col gap-4">
        <div>
          <label
            for="name"
            class="block text-left text-neon-green font-bold mb-2 text-lg"
          >
            <i class="fas fa-user-secret"></i> 이름:
          </label>
          <input
            type="text"
            id="name"
            name="name"
            required
            class="w-full p-4 rounded-xl bg-gray-600 text-white placeholder-gray-400 border border-spooky-purple focus:outline-none focus:ring-4 focus:ring-spooky-purple transition-shadow"
            placeholder="으스스한 이름"
          />
        </div>
        <div>
          <label
            for="phone_number"
            class="block text-left text-neon-green font-bold mb-2 text-lg"
          >
            <i class="fas fa-magic"></i> 전화번호:
          </label>
          <input
            type="tel"
            id="phone_number"
            name="phone_number"
            required
            pattern="[0-9]{11}"
            maxlength="11"
            class="w-full p-4 rounded-xl bg-gray-600 text-white placeholder-gray-400 border border-spooky-purple focus:outline-none focus:ring-4 focus:ring-spooky-purple transition-shadow"
            placeholder="01012345678 (숫자 11자리)"
            title="전화번호는 숫자 11자리만 입력 가능합니다. (예: 01012345678)"
          />
        </div>
        <button
          type="submit"
          id="register-button"
          class="w-full mt-6 p-4 rounded-3xl bg-halloween-orange text-gray-900 font-extrabold text-xl hover:bg-halloween-dark-orange transform hover:scale-[1.05] transition-all shadow-lg"
        >
          <i class="fas fa-hat-wizard"></i> 등록하고 대기하기
        </button>
      </form>

      <p
        id="status-message"
        class="mt-6 p-3 rounded-xl font-bold text-lg transition-colors min-h-12"
      ></p>
    </div>

    <script>
      const registerForm = document.getElementById("register-form");
      const statusMessage = document.getElementById("status-message");
      const phoneNumberInput = document.getElementById("phone_number"); // 새로 추가

      // API BASE URL을 동적으로 설정합니다.
      const API_BASE_URL =
        window.location.protocol + "//" + window.location.host + "/api/v1";

      registerForm.addEventListener("submit", async (event) => {
        event.preventDefault(); // 기본 폼 제출 방지

        // 브라우저 기본 유효성 검사 (required, pattern)를 통과했는지 다시 확인
        if (!registerForm.checkValidity()) {
          // 브라우저가 기본 오류 메시지를 표시하므로 별도의 메시지는 필요 없을 수 있으나,
          // 사용자 정의 오류 메시지를 표시하고 싶다면 아래 코드를 사용합니다.
          // showError('💀 전화번호가 유효하지 않습니다. (숫자 11자리)');
          return;
        }

        const name = document.getElementById("name").value;
        // 전화번호에서 숫자가 아닌 모든 문자 제거
        const rawPhoneNumber = phoneNumberInput.value.replace(/[^0-9]/g, "");
        const phoneNumber = rawPhoneNumber; // 이미 pattern="[0-9]{11}"로 숫자 11자리만 들어오게 제한됨

        // ✅ JS에서 한 번 더 길이 체크 (이중 확인)
        if (phoneNumber.length !== 11) {
          statusMessage.textContent =
            "💀 등록 실패: 전화번호는 정확히 숫자 11자리여야 합니다.";
          statusMessage.className =
            "mt-6 p-3 rounded-xl font-extrabold text-lg bg-spooky-red text-white transition-colors shadow-lg shadow-spooky-red/50 min-h-12";
          return; // 길이가 맞지 않으면 등록을 막음
        }

        // 메시지 초기화 및 로딩 표시
        statusMessage.textContent = "등록 마법을 시전 중...";
        statusMessage.className =
          "mt-6 p-3 rounded-xl font-bold text-lg bg-gray-600 text-white transition-colors min-h-12";

        try {
          const response = await fetch(API_BASE_URL + "/queue/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: name, phone_number: phoneNumber }),
          });

          const data = await response.json();

          if (response.ok) {
            // 성공 시: 네온 그린 배경, 어두운 텍스트
            statusMessage.textContent = `✨ 등록 완료! 대기번호: ${data.id}, 이름: ${data.name}`;
            statusMessage.className =
              "mt-6 p-3 rounded-xl font-extrabold text-lg bg-neon-green text-gray-900 transition-colors shadow-lg shadow-neon-green/50 min-h-12";
            registerForm.reset();
          } else {
            // 실패 시: 으스스한 빨간색 배경, 흰색 텍스트
            statusMessage.textContent = `💀 등록 실패: ${
              data.detail || "알 수 없는 저주"
            }`;
            statusMessage.className =
              "mt-6 p-3 rounded-xl font-extrabold text-lg bg-spooky-red text-white transition-colors shadow-lg shadow-spooky-red/50 min-h-12";
          }
        } catch (error) {
          // 네트워크 오류 시: 으스스한 빨간색 배경
          statusMessage.textContent =
            "👻 네트워크 오류가 발생했습니다. 마법진이 끊어졌습니다.";
          statusMessage.className =
            "mt-6 p-3 rounded-xl font-extrabold text-lg bg-spooky-red text-white transition-colors shadow-lg shadow-spooky-red/50 min-h-12";
          console.error("Error:", error);
        }
      });
    </script>
  </body>
</html>
